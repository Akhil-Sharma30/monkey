from itertools import product
from typing import List

from infection_monkey.exploit.powershell_utils.auth_options import AuthOptions


def get_credentials(
    usernames: List[str], passwords: List[str], is_windows: bool, is_https: bool
) -> List[AuthOptions]:
    credentials = []
    credentials.extend(_get_empty_credentials(is_windows))
    credentials.extend(_get_username_only_credentials(usernames, is_windows))
    credentials.extend(_get_username_password_credentials(usernames, passwords, is_https=is_https))

    return credentials


def _get_empty_credentials(is_windows: bool) -> List[AuthOptions]:
    if is_windows:
        return [AuthOptions(username=None, password=None, is_https=False)]

    return []


def _get_username_only_credentials(usernames: List[str], is_windows: bool) -> List[AuthOptions]:
    credentials = [
        AuthOptions(username=username, password="", is_https=False) for username in usernames
    ]

    if is_windows:
        credentials.extend(
            [AuthOptions(username=username, password=None, is_https=True) for username in usernames]
        )

    return credentials


def _get_username_password_credentials(
    usernames: List[str], passwords: List[str], is_https: bool
) -> List[AuthOptions]:
    username_password_pairs = product(usernames, passwords)

    return [
        AuthOptions(credentials[0], credentials[1], is_https=is_https)
        for credentials in username_password_pairs
    ]
