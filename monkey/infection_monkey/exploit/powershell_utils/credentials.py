from dataclasses import dataclass
from enum import Enum
from itertools import product
from typing import List, Union


class SecretType(Enum):
    CACHED = 1
    PASSWORD = 2
    LM_HASH = 3
    NT_HASH = 4


@dataclass
class Credentials:
    username: Union[str, None]
    secret: Union[str, None]
    secret_type: SecretType


def get_credentials(
    usernames: List[str],
    passwords: List[str],
    lm_hashes: List[str],
    nt_hashes: List[str],
    is_windows: bool,
) -> List[Credentials]:
    credentials = []
    credentials.extend(_get_empty_credentials(is_windows))
    credentials.extend(_get_username_only_credentials(usernames, is_windows))
    credentials.extend(_get_username_password_credentials(usernames, passwords))
    credentials.extend(_get_username_lm_hash_credentials(usernames, lm_hashes))
    credentials.extend(_get_username_nt_hash_credentials(usernames, nt_hashes))

    return credentials


# On Windows systems, when username == None and password == None, the current user's credentials
# will be used to attempt to log into the victim.
def _get_empty_credentials(is_windows: bool) -> List[Credentials]:
    if is_windows:
        return [Credentials(username=None, secret=None, secret_type=SecretType.CACHED)]

    return []


# On Windows systems, when password == None, the current user's password will bu used to attempt to
# log into the victim.
def _get_username_only_credentials(usernames: List[str], is_windows: bool) -> List[Credentials]:
    credentials = [
        Credentials(username=username, secret="", secret_type=SecretType.PASSWORD)
        for username in usernames
    ]

    if is_windows:
        credentials.extend(
            [
                Credentials(username=username, secret=None, secret_type=SecretType.CACHED)
                for username in usernames
            ]
        )

    return credentials


def _get_username_password_credentials(
    usernames: List[str], passwords: List[str]
) -> List[Credentials]:
    return _get_username_secret_credentials(usernames, passwords, SecretType.PASSWORD)


def _get_username_lm_hash_credentials(
    usernames: List[str], lm_hashes: List[str]
) -> List[Credentials]:
    return _get_username_secret_credentials(usernames, lm_hashes, SecretType.LM_HASH)


def _get_username_nt_hash_credentials(
    usernames: List[str], nt_hashes: List[str]
) -> List[Credentials]:
    return _get_username_secret_credentials(usernames, nt_hashes, SecretType.NT_HASH)


def _get_username_secret_credentials(
    usernames: List[str], secrets: List[str], secret_type: SecretType
) -> List[Credentials]:
    username_secret_pairs = product(usernames, secrets)

    return [
        Credentials(credentials[0], credentials[1], secret_type)
        for credentials in username_secret_pairs
    ]
