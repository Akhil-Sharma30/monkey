import io
import logging
import threading
from functools import lru_cache

from common import OperatingSystem
from infection_monkey.island_api_client import IIslandAPIClient, IslandAPIError

from . import IAgentBinaryRepository, RetrievalError

logger = logging.getLogger(__name__)


class CachingAgentBinaryRepository(IAgentBinaryRepository):
    """
    CachingAgentBinaryRepository implements the IAgentBinaryRepository interface and downloads the
    requested agent binary from the island on request. The agent binary is cached so that only one
    request is actually sent to the island for each requested binary.
    """

    def __init__(self, island_api_client: IIslandAPIClient):
        self._lock = threading.Lock()
        self._island_api_client = island_api_client

    def get_agent_binary(
        self, operating_system: OperatingSystem, architecture: str = None
    ) -> io.BytesIO:
        # If multiple calls to get_agent_binary() are made simultaneously before the result of
        # _download_binary_from_island() is cached, then multiple requests will be sent to the
        # island. Add a mutex in front of the call to _download_agent_binary_from_island() so
        # that only one request per OS will be sent to the island.
        with self._lock:
            return io.BytesIO(self._download_binary_from_island(operating_system))

    @lru_cache(maxsize=None)
    def _download_binary_from_island(self, operating_system: OperatingSystem) -> bytes:
        os_name = operating_system.value
        try:
            return self._island_api_client.get_agent_binary(os_name)
        except IslandAPIError as err:
            raise RetrievalError(err)
