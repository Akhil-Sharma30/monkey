from unittest.mock import MagicMock

from infection_monkey.telemetry.base_telem import BaseTelem
from infection_monkey.telemetry.exploit_telem import ExploitTelem
from infection_monkey.telemetry.i_telem import ITelem
from infection_monkey.telemetry.messengers.exploit_intercepting_telemetry_messenger import (
    ExploitInterceptingTelemetryMessenger,
)


class TestTelem(BaseTelem):
    telem_category = None

    def __init__(self):
        pass

    def get_data(self):
        return {}


class MockExpliotTelem(ExploitTelem):
    def __init__(self):
        pass

    def get_data(self):
        return {}


def test_generic_telemetry():
    mock_telemetry_messenger = MagicMock()
    mock_tunnel = MagicMock()

    telemetry_messenger = ExploitInterceptingTelemetryMessenger(
        mock_telemetry_messenger, mock_tunnel
    )

    telemetry_messenger.send_telemetry(TestTelem())

    assert mock_telemetry_messenger.send_telemetry.called
    assert not mock_tunnel.set_wait_for_exploited_machines.called


def test_expliot_telemetry():
    mock_telemetry_messenger = MagicMock()
    mock_tunnel = MagicMock()
    mock_expliot_telem = MockExpliotTelem()

    telemetry_messenger = ExploitInterceptingTelemetryMessenger(
        mock_telemetry_messenger, mock_tunnel
    )

    telemetry_messenger.send_telemetry(mock_expliot_telem)

    assert mock_telemetry_messenger.send_telemetry.called
    assert mock_tunnel.set_wait_for_exploited_machines.called
