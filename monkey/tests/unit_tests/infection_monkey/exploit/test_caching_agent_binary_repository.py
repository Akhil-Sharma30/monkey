from multiprocessing import Queue, get_context

import pytest
from tests.unit_tests.infection_monkey.base_island_api_client import BaseIslandAPIClient

from common import OperatingSystem
from infection_monkey.exploit import CachingAgentBinaryRepository
from infection_monkey.island_api_client import IIslandAPIClient

AGENT_BINARY = b"BINARY_EXECUTABLE"
AGENT_BINARY_LINUX = b"LINUX_BINARY"


@pytest.fixture
def mock_island_api_client() -> IIslandAPIClient:
    return StubIslandAPIClient()


class StubIslandAPIClient(BaseIslandAPIClient):
    def __init__(self):
        self._calls = get_context("spawn").Value("i", 0)

    @property
    def calls(self):
        return self._calls.value

    def get_agent_binary(self, operating_system: OperatingSystem) -> bytes:
        with self._calls.get_lock():
            self._calls.value += 1
            if operating_system is OperatingSystem.LINUX:
                return AGENT_BINARY_LINUX
            return AGENT_BINARY


def test_get_agent_binary__uses_cache(mock_island_api_client):
    caching_agent_binary_repository = CachingAgentBinaryRepository(mock_island_api_client)

    binary1 = caching_agent_binary_repository.get_agent_binary(OperatingSystem.WINDOWS)
    binary2 = caching_agent_binary_repository.get_agent_binary(OperatingSystem.WINDOWS)

    assert binary1.getvalue() == AGENT_BINARY
    assert binary2.getvalue() == AGENT_BINARY
    assert mock_island_api_client.calls == 1


def get_binary(
    agent_binary_repository: CachingAgentBinaryRepository,
    queue: Queue,
    os: OperatingSystem,
):
    agent_binary = agent_binary_repository.get_agent_binary(os)
    queue.put(agent_binary)


def test_get_agent_binary__uses_multiprocess_cache(mock_island_api_client):
    caching_agent_binary_repository = CachingAgentBinaryRepository(mock_island_api_client)
    context = get_context("spawn")
    queue = context.Queue()

    p1 = context.Process(
        target=get_binary, args=(caching_agent_binary_repository, queue, OperatingSystem.WINDOWS)
    )
    p1.start()
    p1_binary = queue.get()
    p1.join()

    p2 = context.Process(
        target=get_binary, args=(caching_agent_binary_repository, queue, OperatingSystem.WINDOWS)
    )
    p2.start()
    p2_binary = queue.get()
    p2.join()

    assert p1_binary.getvalue() == AGENT_BINARY
    assert p2_binary.getvalue() == AGENT_BINARY
    assert mock_island_api_client.calls == 1


def test_get_agent_binary__uses_multiprocess_cache_concurrently(mock_island_api_client):
    caching_agent_binary_repository = CachingAgentBinaryRepository(mock_island_api_client)
    context = get_context("spawn")
    queue = context.Queue()

    p1 = context.Process(
        target=get_binary, args=(caching_agent_binary_repository, queue, OperatingSystem.WINDOWS)
    )
    p2 = context.Process(
        target=get_binary, args=(caching_agent_binary_repository, queue, OperatingSystem.WINDOWS)
    )
    p1.start()
    p2.start()
    binary1 = queue.get()
    binary2 = queue.get()
    p1.join()
    p2.join()

    assert binary1.getvalue() == AGENT_BINARY
    assert binary2.getvalue() == AGENT_BINARY
    assert mock_island_api_client.calls == 1
