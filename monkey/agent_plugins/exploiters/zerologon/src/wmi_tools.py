import logging
import threading
from functools import wraps

logger = logging.getLogger(__name__)


# Due to the limitations of impacket library we should only run one WmiConnection at a time
# Use impacket_user decorator to ensure that no race conditions are happening
# See comments in https://github.com/guardicore/monkey/pull/1766
lock = threading.Lock()


class WmiTools(object):
    @staticmethod
    def impacket_user(func):
        @wraps(func)
        def _wrapper(*args, **kwarg):
            logger.debug("Waiting for impacket lock")
            with lock:
                logger.debug("Acquired impacket lock")
                return func(*args, **kwarg)

        return _wrapper
